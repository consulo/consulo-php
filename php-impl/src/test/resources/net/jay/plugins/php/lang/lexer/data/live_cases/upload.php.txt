<div class="pageBefore">
    <img src="<?php echo $this->GetConfigValue("root_url"); ?>images/z.gif" width="1" height="1" border="0" alt="" style="display:block" align="top" />
</div>
<div class="page"><?php

if ($user = $this->getUser()) {
	$user = strtolower($this->GetUserName());
	$registered = true;
} else {
    $user = 'guest@wacko';
}

if ($registered
    && (($this->config["upload"] === true)
        || ($this->config["upload"] == "1")
        || ($this->CheckACL($user,$this->config["upload"])))
    && ($this->HasAccess("write") && $this->HasAccess("read")))
{
	if (!$this->page) {
		echo str_replace('%1', $this->href('edit'), $this->getResourceValue('DoesNotExists'));
	} elseif ($_GET['remove']) {
		// show the form
		if ($_GET['remove'] == 'global') {
			$page_id = 0;
		} else {
			$page_id = $this->page['id'];
		}
		$sql = 'SELECT user, id, filename, filesize, description FROM '.$this->config['table_prefix'].'upload'.
				" WHERE page_id='".quote($page_id)."' AND filename='".quote($_GET['file'])."'";
		$what = $this->loadAll($sql);
		if (sizeof($what) > 0) {
			if ($this->isAdmin() || ($page_id && ($this->getPageOwner($this->tag)==$this->getUserName()))
				|| ($what[0]['user']==$this->getUserName()))
            {
				echo '<h1>'.$this->getResourceValue('UploadRemoveConfirm').'</h1>';
				echo $this->formOpen('upload');
				// !!!!! ????‡‚??? ?‰??? ?????? ?‡ ?‰‡?????? ?‡??
                ?><br />
                <ul>
                    <li><?=$this->link('file:'.($_GET['remove']=='global'?'':$this->tag.'/').$_GET['file'])?></li>
                </ul><br />
                <input type="hidden" name="remove" value="<?php echo $_GET["remove"]?>" />
                <input type="hidden" name="file" value="<?php echo $_GET["file"]?>" />
                <input name="submit" class="OkBtn_Top" onmouseover='this.className="OkBtn_Top_";' onmouseout ='this.className="OkBtn_Top";' type="submit" align="top" value="<?=$this->getResourceValue('RemoveButton')?>" />
                <input class="CancelBtn_Top" onmouseover='this.className="CancelBtn_Top_";' onmouseout ='this.className="CancelBtn_Top";' type="button" align="top" value="<?=str_replace("\n",' ', $this->getResourceValue('EditCancelButton'))?>" onclick="document.location='<?=addslashes($this->href(''))?>';" /><br /><br />
	            <?= $this->FormClose() ?> <?
			} else {
				echo $this->getResourceValue('UploadRemoveDenied');
			}
		} else {
			echo $this->getResourceValue('UploadFileNotFound');
		}
        ?></div><?
		return true;
	} elseif ($_POST['remove']) {
		// delete
		// 1. where, existence
		if ($_POST['remove'] == 'global') {
			$page_id = 0;
		} else {
			$page_id = $this->page['id'];
		}
		$sql = 'SELECT user, id, filename, filesize, description FROM '.$this->config['table_prefix'].'upload'.
				" WHERE page_id='".quote($page_id)."' AND filename='".quote($_POST["file"])."'";
		$what = $this->LoadAll($sql);
		if (sizeof($what) > 0) {
			if ($this->isAdmin() || ($page_id && ($this->getPageOwner($this->tag)==$this->getUserName()))
				|| ($what[0]['user']==$this->getUserName()))
            {
				// 2. remove from DB
				$sql = 'DELETE FROM '.$this->config['table_prefix']."upload WHERE id='".quote($what[0]["id"])."'";
				$this->query($sql);
				echo '<div>'.$this->getResourceValue('UploadRemovedFromDB').'</div>';
				// 3. remove from FS
				$real_filename = ($page_id ? $this->config['upload_path_per_page'].'/@'.str_replace('/', '@', $this->supertag).'@' : $this->config['upload_path'].'/') .$what[0]["filename"];
				if (@unlink($real_filename)) {
					echo '<div>'.$this->getResourceValue('UploadRemovedFromFS').'</div><br /><br />';
				} else {
					echo '<div style="color:#ff0000">'.$this->getResourceValue('UploadRemovedFromFSError').'</div><br /><br />';
				}
			} else {
				echo $this->getResourceValue('UploadRemoveDenied');
			}
		} else {
			echo $this->getResourceValue('UploadRemoveNotFound');
		}
	} else {
		$user = $this->getUser();
		$sql = 'SELECT id FROM '.$this->config['table_prefix']."upload WHERE user='".quote($user['name'])."'";
		$files = $this->loadAll($sql);
		if (!$this->config['upload_max_per_user'] || (sizeof($files) < $this->config['upload_max_per_user'])) {
			if (is_uploaded_file($_FILES['file']['tmp_name'])) {
				// there is file
				// 1. check out $data
				$_data = explode('.', $_FILES['file']['name']);
				$ext = $_data[sizeof($_data)-1];
				unset($_data[ sizeof($_data)-1]);
				$name = implode('.', $_data);
				$name = str_replace('@', '_', $name);

				// here would be place for translit
				$name = $this->format($name, 'translit');

				// 1.5. +write @PageSupertag@SubPage@ to name
                $name = '@' . str_replace('/', '@', $this->page['supertag']) . '@' . $name;

                $dir = $this->config['upload_path_per_page'] . '/';

				$_name = $name;
				$count = 1;
				while (file_exists($dir . $name . '.' . $ext)) {
					if ($name === $_name) {
						$name = $_name . $count;
					} else {
						$name = $_name . (++$count);
					}
				}

				$result_name = $name . '.' . $ext;
				$file_size = $_FILES['file']['size'];

				// 1.6. check filesize, if asked
				$maxfilesize = $this->config['upload_max_size'];
				if ($_POST['maxsize'] && $maxfilesize > 1 * $_POST['maxsize']) {
					$maxfilesize = 1 * $_POST['maxsize'];
				}
				if ($file_size < $maxfilesize * 1024) {
					// 1.7. check is image, if asked
					$forbid = 0;
					$size = array(0, 0);
					$src = $_FILES['file']['tmp_name'];
					$size = @getimagesize($src);

					if ($this->config['upload_images_only'] && $size[0] == 0) {
						$forbid = 1;
					}
					if (isset($size[2]) && ($size[2] < 1 || $size[2] > 3)) {
						$size[0] = 0;
						$size[1] = 0;
					}
					if (!$forbid) {
						// 3. save to permanent location
						if (move_uploaded_file($_FILES['file']['tmp_name'], $dir.$result_name)) {
							chmod($dir.$result_name, 0744);

                            $small_name = explode('@', $result_name);
                            $small_name = $small_name[sizeof($small_name)-1];
							$description = substr(quote($_POST['description']), 0, 250);
							$description = rtrim($description, "\\");

							// 5. insert line into DB
							$sql = 'INSERT INTO '.$this->config['table_prefix'].'upload'.
									" SET page_id=".quote($is_global?'NULL':$this->page['id']).
										", filename='".quote($small_name)."', description='".quote($description)."'".
										", filesize='".quote($file_size)."', picture_w='".quote($size[0])."'".
										", picture_h='".quote($size[1])."', file_ext='".quote(substr($ext,0,10))."'".
										", user='".quote($user["name"])."', uploaded_dt='".quote(date('Y-m-d H:i:s'))."' ";
							$this->query($sql);

							// 4. output link to file
							// !!!!! write after providing filelink syntax
                            ?><h1><?=$this->getResourceValue('UploadDone')?></h1>
                            <br />
                            <?= 'file:/' . ($this->tag . '/') . $small_name ?>
                            <br /><br /><?
						} else {
							//cannot write file
							$error = $this->getResourceValue('UploadCannotWrite');
						}
					} else {
						//forbid
						$error = $this->getResourceValue('UploadNotAPicture');
					}
				} else {
					//maxsize
					$error = $this->getResourceValue('UploadMaxSizeReached');
				}
			} else {
				//!is_uploaded_file
				if ($_FILES['file']['error']==UPLOAD_ERR_INI_SIZE || $_FILES['file']['error']==UPLOAD_ERR_FORM_SIZE) {
					$error = $this->getResourceValue('UploadMaxSizeReached');
				} elseif ($_FILES['file']['error']==UPLOAD_ERR_PARTIAL || $_FILES['file']['error']==UPLOAD_ERR_NO_FILE) {
					$error = $this->getResourceValue('UploadNoFile');
				} else {
					$error = $this->getResourceValue('UploadMaxSizeReached');
				}
			}
		} else {
			$error = $this->getResourceValue('UploadMaxFileCount');
		}
	}
	if ($error) {
		echo $error."<br /><br />";
	}
	echo $this->action('upload', array()).'<br />';
	echo $this->action('files', array());
} else {
	echo $this->getResourceValue('UploadForbidden');
}
if (!$this->getConfigValue('revisions_hide_cancel')) {
	echo '<input type="button" value="'.$this->getResourceValue('CancelDifferencesButton').'" onclick="document.location=\''.addslashes($this->href(''))."';\" />\n";
}
?>
</div>
---------------
html('<div class="pageBefore">\n    <img src="')
php opening tag('<?php ')
echo('echo')
variable('$this')
arrow('->')
identifier('GetConfigValue')
(('(')
string('"root_url"')
)(')')
semicolon(';')
php closing tag('?>')
html('images/z.gif" width="1" height="1" border="0" alt="" style="display:block" align="top" />\n</div>\n<div class="page">')
php opening tag('<?php\n')
if('if')
(('(')
variable('$user')
assign('=')
variable('$this')
arrow('->')
identifier('getUser')
(('(')
)(')')
)(')')
{('{')
variable('$user')
assign('=')
identifier('strtolower')
(('(')
variable('$this')
arrow('->')
identifier('GetUserName')
(('(')
)(')')
)(')')
semicolon(';')
variable('$registered')
assign('=')
identifier('true')
semicolon(';')
}('}')
else('else')
{('{')
variable('$user')
assign('=')
single quoted string(''guest@wacko'')
semicolon(';')
}('}')
if('if')
(('(')
variable('$registered')
and('&&')
(('(')
(('(')
variable('$this')
arrow('->')
identifier('config')
[('[')
string('"upload"')
](']')
identical('===')
identifier('true')
)(')')
or('||')
(('(')
variable('$this')
arrow('->')
identifier('config')
[('[')
string('"upload"')
](']')
equals('==')
string('"1"')
)(')')
or('||')
(('(')
variable('$this')
arrow('->')
identifier('CheckACL')
(('(')
variable('$user')
comma(',')
variable('$this')
arrow('->')
identifier('config')
[('[')
string('"upload"')
](']')
)(')')
)(')')
)(')')
and('&&')
(('(')
variable('$this')
arrow('->')
identifier('HasAccess')
(('(')
string('"write"')
)(')')
and('&&')
variable('$this')
arrow('->')
identifier('HasAccess')
(('(')
string('"read"')
)(')')
)(')')
)(')')
{('{')
if('if')
(('(')
not('!')
variable('$this')
arrow('->')
identifier('page')
)(')')
{('{')
echo('echo')
identifier('str_replace')
(('(')
single quoted string(''%1'')
comma(',')
variable('$this')
arrow('->')
identifier('href')
(('(')
single quoted string(''edit'')
)(')')
comma(',')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''DoesNotExists'')
)(')')
)(')')
semicolon(';')
}('}')
elseif('elseif')
(('(')
variable('$_GET')
[('[')
single quoted string(''remove'')
](']')
)(')')
{('{')
line comment('// show the form')
if('if')
(('(')
variable('$_GET')
[('[')
single quoted string(''remove'')
](']')
equals('==')
single quoted string(''global'')
)(')')
{('{')
variable('$page_id')
assign('=')
integer('0')
semicolon(';')
}('}')
else('else')
{('{')
variable('$page_id')
assign('=')
variable('$this')
arrow('->')
identifier('page')
[('[')
single quoted string(''id'')
](']')
semicolon(';')
}('}')
variable('$sql')
assign('=')
single quoted string(''SELECT user, id, filename, filesize, description FROM '')
dot('.')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''table_prefix'')
](']')
dot('.')
single quoted string(''upload'')
dot('.')
string('" WHERE page_id='"')
dot('.')
identifier('quote')
(('(')
variable('$page_id')
)(')')
dot('.')
string('"' AND filename='"')
dot('.')
identifier('quote')
(('(')
variable('$_GET')
[('[')
single quoted string(''file'')
](']')
)(')')
dot('.')
string('"'"')
semicolon(';')
variable('$what')
assign('=')
variable('$this')
arrow('->')
identifier('loadAll')
(('(')
variable('$sql')
)(')')
semicolon(';')
if('if')
(('(')
identifier('sizeof')
(('(')
variable('$what')
)(')')
greater than('>')
integer('0')
)(')')
{('{')
if('if')
(('(')
variable('$this')
arrow('->')
identifier('isAdmin')
(('(')
)(')')
or('||')
(('(')
variable('$page_id')
and('&&')
(('(')
variable('$this')
arrow('->')
identifier('getPageOwner')
(('(')
variable('$this')
arrow('->')
identifier('tag')
)(')')
equals('==')
variable('$this')
arrow('->')
identifier('getUserName')
(('(')
)(')')
)(')')
)(')')
or('||')
(('(')
variable('$what')
[('[')
integer('0')
](']')
[('[')
single quoted string(''user'')
](']')
equals('==')
variable('$this')
arrow('->')
identifier('getUserName')
(('(')
)(')')
)(')')
)(')')
{('{')
echo('echo')
single quoted string(''<h1>'')
dot('.')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemoveConfirm'')
)(')')
dot('.')
single quoted string(''</h1>'')
semicolon(';')
echo('echo')
variable('$this')
arrow('->')
identifier('formOpen')
(('(')
single quoted string(''upload'')
)(')')
semicolon(';')
line comment('// !!!!! ????????? ????? ?????? ?? ????????? ????')
php closing tag('?>')
html('<br />\n                <ul>\n                    <li>')
php echo opening tag('<?=')
variable('$this')
arrow('->')
identifier('link')
(('(')
single quoted string(''file:'')
dot('.')
(('(')
variable('$_GET')
[('[')
single quoted string(''remove'')
](']')
equals('==')
single quoted string(''global'')
ternary('?')
single quoted string('''')
colon(':')
variable('$this')
arrow('->')
identifier('tag')
dot('.')
single quoted string(''/'')
)(')')
dot('.')
variable('$_GET')
[('[')
single quoted string(''file'')
](']')
)(')')
php closing tag('?>')
html('</li>\n                </ul><br />\n                <input type="hidden" name="remove" value="')
php opening tag('<?php ')
echo('echo')
variable('$_GET')
[('[')
string('"remove"')
](']')
php closing tag('?>')
html('" />\n                <input type="hidden" name="file" value="')
php opening tag('<?php ')
echo('echo')
variable('$_GET')
[('[')
string('"file"')
](']')
php closing tag('?>')
html('" />\n                <input name="submit" class="OkBtn_Top" onmouseover='this.className="OkBtn_Top_";' onmouseout ='this.className="OkBtn_Top";' type="submit" align="top" value="')
php echo opening tag('<?=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''RemoveButton'')
)(')')
php closing tag('?>')
html('" />\n                <input class="CancelBtn_Top" onmouseover='this.className="CancelBtn_Top_";' onmouseout ='this.className="CancelBtn_Top";' type="button" align="top" value="')
php echo opening tag('<?=')
identifier('str_replace')
(('(')
string('"\n"')
comma(',')
single quoted string('' '')
comma(',')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''EditCancelButton'')
)(')')
)(')')
php closing tag('?>')
html('" onclick="document.location='')
php echo opening tag('<?=')
identifier('addslashes')
(('(')
variable('$this')
arrow('->')
identifier('href')
(('(')
single quoted string('''')
)(')')
)(')')
php closing tag('?>')
html('';" /><br /><br />\n\t            ')
php echo opening tag('<?=')
variable('$this')
arrow('->')
identifier('FormClose')
(('(')
)(')')
php closing tag('?>')
html(' ')
php opening tag('<?')
}('}')
else('else')
{('{')
echo('echo')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemoveDenied'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
echo('echo')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadFileNotFound'')
)(')')
semicolon(';')
}('}')
php closing tag('?>')
html('</div>')
php opening tag('<?')
return('return')
identifier('true')
semicolon(';')
}('}')
elseif('elseif')
(('(')
variable('$_POST')
[('[')
single quoted string(''remove'')
](']')
)(')')
{('{')
line comment('// delete')
line comment('// 1. where, existence')
if('if')
(('(')
variable('$_POST')
[('[')
single quoted string(''remove'')
](']')
equals('==')
single quoted string(''global'')
)(')')
{('{')
variable('$page_id')
assign('=')
integer('0')
semicolon(';')
}('}')
else('else')
{('{')
variable('$page_id')
assign('=')
variable('$this')
arrow('->')
identifier('page')
[('[')
single quoted string(''id'')
](']')
semicolon(';')
}('}')
variable('$sql')
assign('=')
single quoted string(''SELECT user, id, filename, filesize, description FROM '')
dot('.')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''table_prefix'')
](']')
dot('.')
single quoted string(''upload'')
dot('.')
string('" WHERE page_id='"')
dot('.')
identifier('quote')
(('(')
variable('$page_id')
)(')')
dot('.')
string('"' AND filename='"')
dot('.')
identifier('quote')
(('(')
variable('$_POST')
[('[')
string('"file"')
](']')
)(')')
dot('.')
string('"'"')
semicolon(';')
variable('$what')
assign('=')
variable('$this')
arrow('->')
identifier('LoadAll')
(('(')
variable('$sql')
)(')')
semicolon(';')
if('if')
(('(')
identifier('sizeof')
(('(')
variable('$what')
)(')')
greater than('>')
integer('0')
)(')')
{('{')
if('if')
(('(')
variable('$this')
arrow('->')
identifier('isAdmin')
(('(')
)(')')
or('||')
(('(')
variable('$page_id')
and('&&')
(('(')
variable('$this')
arrow('->')
identifier('getPageOwner')
(('(')
variable('$this')
arrow('->')
identifier('tag')
)(')')
equals('==')
variable('$this')
arrow('->')
identifier('getUserName')
(('(')
)(')')
)(')')
)(')')
or('||')
(('(')
variable('$what')
[('[')
integer('0')
](']')
[('[')
single quoted string(''user'')
](']')
equals('==')
variable('$this')
arrow('->')
identifier('getUserName')
(('(')
)(')')
)(')')
)(')')
{('{')
line comment('// 2. remove from DB')
variable('$sql')
assign('=')
single quoted string(''DELETE FROM '')
dot('.')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''table_prefix'')
](']')
dot('.')
string('"upload WHERE id='"')
dot('.')
identifier('quote')
(('(')
variable('$what')
[('[')
integer('0')
](']')
[('[')
string('"id"')
](']')
)(')')
dot('.')
string('"'"')
semicolon(';')
variable('$this')
arrow('->')
identifier('query')
(('(')
variable('$sql')
)(')')
semicolon(';')
echo('echo')
single quoted string(''<div>'')
dot('.')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemovedFromDB'')
)(')')
dot('.')
single quoted string(''</div>'')
semicolon(';')
line comment('// 3. remove from FS')
variable('$real_filename')
assign('=')
(('(')
variable('$page_id')
ternary('?')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_path_per_page'')
](']')
dot('.')
single quoted string(''/@'')
dot('.')
identifier('str_replace')
(('(')
single quoted string(''/'')
comma(',')
single quoted string(''@'')
comma(',')
variable('$this')
arrow('->')
identifier('supertag')
)(')')
dot('.')
single quoted string(''@'')
colon(':')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_path'')
](']')
dot('.')
single quoted string(''/'')
)(')')
dot('.')
variable('$what')
[('[')
integer('0')
](']')
[('[')
string('"filename"')
](']')
semicolon(';')
if('if')
(('(')
error silence('@')
identifier('unlink')
(('(')
variable('$real_filename')
)(')')
)(')')
{('{')
echo('echo')
single quoted string(''<div>'')
dot('.')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemovedFromFS'')
)(')')
dot('.')
single quoted string(''</div><br /><br />'')
semicolon(';')
}('}')
else('else')
{('{')
echo('echo')
single quoted string(''<div style="color:#ff0000">'')
dot('.')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemovedFromFSError'')
)(')')
dot('.')
single quoted string(''</div><br /><br />'')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
echo('echo')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemoveDenied'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
echo('echo')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadRemoveNotFound'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
variable('$user')
assign('=')
variable('$this')
arrow('->')
identifier('getUser')
(('(')
)(')')
semicolon(';')
variable('$sql')
assign('=')
single quoted string(''SELECT id FROM '')
dot('.')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''table_prefix'')
](']')
dot('.')
string('"upload WHERE user='"')
dot('.')
identifier('quote')
(('(')
variable('$user')
[('[')
single quoted string(''name'')
](']')
)(')')
dot('.')
string('"'"')
semicolon(';')
variable('$files')
assign('=')
variable('$this')
arrow('->')
identifier('loadAll')
(('(')
variable('$sql')
)(')')
semicolon(';')
if('if')
(('(')
not('!')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_max_per_user'')
](']')
or('||')
(('(')
identifier('sizeof')
(('(')
variable('$files')
)(')')
less than('<')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_max_per_user'')
](']')
)(')')
)(')')
{('{')
if('if')
(('(')
identifier('is_uploaded_file')
(('(')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''tmp_name'')
](']')
)(')')
)(')')
{('{')
line comment('// there is file')
line comment('// 1. check out $data')
variable('$_data')
assign('=')
identifier('explode')
(('(')
single quoted string(''.'')
comma(',')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''name'')
](']')
)(')')
semicolon(';')
variable('$ext')
assign('=')
variable('$_data')
[('[')
identifier('sizeof')
(('(')
variable('$_data')
)(')')
minus('-')
integer('1')
](']')
semicolon(';')
unset('unset')
(('(')
variable('$_data')
[('[')
identifier('sizeof')
(('(')
variable('$_data')
)(')')
minus('-')
integer('1')
](']')
)(')')
semicolon(';')
variable('$name')
assign('=')
identifier('implode')
(('(')
single quoted string(''.'')
comma(',')
variable('$_data')
)(')')
semicolon(';')
variable('$name')
assign('=')
identifier('str_replace')
(('(')
single quoted string(''@'')
comma(',')
single quoted string(''_'')
comma(',')
variable('$name')
)(')')
semicolon(';')
line comment('// here would be place for translit')
variable('$name')
assign('=')
variable('$this')
arrow('->')
identifier('format')
(('(')
variable('$name')
comma(',')
single quoted string(''translit'')
)(')')
semicolon(';')
line comment('// 1.5. +write @PageSupertag@SubPage@ to name')
variable('$name')
assign('=')
single quoted string(''@'')
dot('.')
identifier('str_replace')
(('(')
single quoted string(''/'')
comma(',')
single quoted string(''@'')
comma(',')
variable('$this')
arrow('->')
identifier('page')
[('[')
single quoted string(''supertag'')
](']')
)(')')
dot('.')
single quoted string(''@'')
dot('.')
variable('$name')
semicolon(';')
variable('$dir')
assign('=')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_path_per_page'')
](']')
dot('.')
single quoted string(''/'')
semicolon(';')
variable('$_name')
assign('=')
variable('$name')
semicolon(';')
variable('$count')
assign('=')
integer('1')
semicolon(';')
while('while')
(('(')
identifier('file_exists')
(('(')
variable('$dir')
dot('.')
variable('$name')
dot('.')
single quoted string(''.'')
dot('.')
variable('$ext')
)(')')
)(')')
{('{')
if('if')
(('(')
variable('$name')
identical('===')
variable('$_name')
)(')')
{('{')
variable('$name')
assign('=')
variable('$_name')
dot('.')
variable('$count')
semicolon(';')
}('}')
else('else')
{('{')
variable('$name')
assign('=')
variable('$_name')
dot('.')
(('(')
increment('++')
variable('$count')
)(')')
semicolon(';')
}('}')
}('}')
variable('$result_name')
assign('=')
variable('$name')
dot('.')
single quoted string(''.'')
dot('.')
variable('$ext')
semicolon(';')
variable('$file_size')
assign('=')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''size'')
](']')
semicolon(';')
line comment('// 1.6. check filesize, if asked')
variable('$maxfilesize')
assign('=')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_max_size'')
](']')
semicolon(';')
if('if')
(('(')
variable('$_POST')
[('[')
single quoted string(''maxsize'')
](']')
and('&&')
variable('$maxfilesize')
greater than('>')
integer('1')
multiply('*')
variable('$_POST')
[('[')
single quoted string(''maxsize'')
](']')
)(')')
{('{')
variable('$maxfilesize')
assign('=')
integer('1')
multiply('*')
variable('$_POST')
[('[')
single quoted string(''maxsize'')
](']')
semicolon(';')
}('}')
if('if')
(('(')
variable('$file_size')
less than('<')
variable('$maxfilesize')
multiply('*')
integer('1024')
)(')')
{('{')
line comment('// 1.7. check is image, if asked')
variable('$forbid')
assign('=')
integer('0')
semicolon(';')
variable('$size')
assign('=')
array('array')
(('(')
integer('0')
comma(',')
integer('0')
)(')')
semicolon(';')
variable('$src')
assign('=')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''tmp_name'')
](']')
semicolon(';')
variable('$size')
assign('=')
error silence('@')
identifier('getimagesize')
(('(')
variable('$src')
)(')')
semicolon(';')
if('if')
(('(')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''upload_images_only'')
](']')
and('&&')
variable('$size')
[('[')
integer('0')
](']')
equals('==')
integer('0')
)(')')
{('{')
variable('$forbid')
assign('=')
integer('1')
semicolon(';')
}('}')
if('if')
(('(')
isset keyword('isset')
(('(')
variable('$size')
[('[')
integer('2')
](']')
)(')')
and('&&')
(('(')
variable('$size')
[('[')
integer('2')
](']')
less than('<')
integer('1')
or('||')
variable('$size')
[('[')
integer('2')
](']')
greater than('>')
integer('3')
)(')')
)(')')
{('{')
variable('$size')
[('[')
integer('0')
](']')
assign('=')
integer('0')
semicolon(';')
variable('$size')
[('[')
integer('1')
](']')
assign('=')
integer('0')
semicolon(';')
}('}')
if('if')
(('(')
not('!')
variable('$forbid')
)(')')
{('{')
line comment('// 3. save to permanent location')
if('if')
(('(')
identifier('move_uploaded_file')
(('(')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''tmp_name'')
](']')
comma(',')
variable('$dir')
dot('.')
variable('$result_name')
)(')')
)(')')
{('{')
identifier('chmod')
(('(')
variable('$dir')
dot('.')
variable('$result_name')
comma(',')
integer('0744')
)(')')
semicolon(';')
variable('$small_name')
assign('=')
identifier('explode')
(('(')
single quoted string(''@'')
comma(',')
variable('$result_name')
)(')')
semicolon(';')
variable('$small_name')
assign('=')
variable('$small_name')
[('[')
identifier('sizeof')
(('(')
variable('$small_name')
)(')')
minus('-')
integer('1')
](']')
semicolon(';')
variable('$description')
assign('=')
identifier('substr')
(('(')
identifier('quote')
(('(')
variable('$_POST')
[('[')
single quoted string(''description'')
](']')
)(')')
comma(',')
integer('0')
comma(',')
integer('250')
)(')')
semicolon(';')
variable('$description')
assign('=')
identifier('rtrim')
(('(')
variable('$description')
comma(',')
string('"\\"')
)(')')
semicolon(';')
line comment('// 5. insert line into DB')
variable('$sql')
assign('=')
single quoted string(''INSERT INTO '')
dot('.')
variable('$this')
arrow('->')
identifier('config')
[('[')
single quoted string(''table_prefix'')
](']')
dot('.')
single quoted string(''upload'')
dot('.')
string('" SET page_id="')
dot('.')
identifier('quote')
(('(')
variable('$is_global')
ternary('?')
single quoted string(''NULL'')
colon(':')
variable('$this')
arrow('->')
identifier('page')
[('[')
single quoted string(''id'')
](']')
)(')')
dot('.')
string('", filename='"')
dot('.')
identifier('quote')
(('(')
variable('$small_name')
)(')')
dot('.')
string('"', description='"')
dot('.')
identifier('quote')
(('(')
variable('$description')
)(')')
dot('.')
string('"'"')
dot('.')
string('", filesize='"')
dot('.')
identifier('quote')
(('(')
variable('$file_size')
)(')')
dot('.')
string('"', picture_w='"')
dot('.')
identifier('quote')
(('(')
variable('$size')
[('[')
integer('0')
](']')
)(')')
dot('.')
string('"'"')
dot('.')
string('", picture_h='"')
dot('.')
identifier('quote')
(('(')
variable('$size')
[('[')
integer('1')
](']')
)(')')
dot('.')
string('"', file_ext='"')
dot('.')
identifier('quote')
(('(')
identifier('substr')
(('(')
variable('$ext')
comma(',')
integer('0')
comma(',')
integer('10')
)(')')
)(')')
dot('.')
string('"'"')
dot('.')
string('", user='"')
dot('.')
identifier('quote')
(('(')
variable('$user')
[('[')
string('"name"')
](']')
)(')')
dot('.')
string('"', uploaded_dt='"')
dot('.')
identifier('quote')
(('(')
identifier('date')
(('(')
single quoted string(''Y-m-d H:i:s'')
)(')')
)(')')
dot('.')
string('"' "')
semicolon(';')
variable('$this')
arrow('->')
identifier('query')
(('(')
variable('$sql')
)(')')
semicolon(';')
line comment('// 4. output link to file')
line comment('// !!!!! write after providing filelink syntax')
php closing tag('?>')
html('<h1>')
php echo opening tag('<?=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadDone'')
)(')')
php closing tag('?>')
html('</h1>\n                            <br />\n                            ')
php echo opening tag('<?=')
single quoted string(''file:/'')
dot('.')
(('(')
variable('$this')
arrow('->')
identifier('tag')
dot('.')
single quoted string(''/'')
)(')')
dot('.')
variable('$small_name')
php closing tag('?>\n')
html('                            <br /><br />')
php opening tag('<?')
}('}')
else('else')
{('{')
line comment('//cannot write file')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadCannotWrite'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
line comment('//forbid')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadNotAPicture'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
line comment('//maxsize')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadMaxSizeReached'')
)(')')
semicolon(';')
}('}')
}('}')
else('else')
{('{')
line comment('//!is_uploaded_file')
if('if')
(('(')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''error'')
](']')
equals('==')
identifier('UPLOAD_ERR_INI_SIZE')
or('||')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''error'')
](']')
equals('==')
identifier('UPLOAD_ERR_FORM_SIZE')
)(')')
{('{')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadMaxSizeReached'')
)(')')
semicolon(';')
}('}')
elseif('elseif')
(('(')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''error'')
](']')
equals('==')
identifier('UPLOAD_ERR_PARTIAL')
or('||')
variable('$_FILES')
[('[')
single quoted string(''file'')
](']')
[('[')
single quoted string(''error'')
](']')
equals('==')
identifier('UPLOAD_ERR_NO_FILE')
)(')')
{('{')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadNoFile'')
)(')')
semicolon(';')
}('}')
else('else')
{('{')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadMaxSizeReached'')
)(')')
semicolon(';')
}('}')
}('}')
}('}')
else('else')
{('{')
variable('$error')
assign('=')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadMaxFileCount'')
)(')')
semicolon(';')
}('}')
}('}')
if('if')
(('(')
variable('$error')
)(')')
{('{')
echo('echo')
variable('$error')
dot('.')
string('"<br /><br />"')
semicolon(';')
}('}')
echo('echo')
variable('$this')
arrow('->')
identifier('action')
(('(')
single quoted string(''upload'')
comma(',')
array('array')
(('(')
)(')')
)(')')
dot('.')
single quoted string(''<br />'')
semicolon(';')
echo('echo')
variable('$this')
arrow('->')
identifier('action')
(('(')
single quoted string(''files'')
comma(',')
array('array')
(('(')
)(')')
)(')')
semicolon(';')
}('}')
else('else')
{('{')
echo('echo')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''UploadForbidden'')
)(')')
semicolon(';')
}('}')
if('if')
(('(')
not('!')
variable('$this')
arrow('->')
identifier('getConfigValue')
(('(')
single quoted string(''revisions_hide_cancel'')
)(')')
)(')')
{('{')
echo('echo')
single quoted string(''<input type="button" value="'')
dot('.')
variable('$this')
arrow('->')
identifier('getResourceValue')
(('(')
single quoted string(''CancelDifferencesButton'')
)(')')
dot('.')
single quoted string(''" onclick="document.location=\''')
dot('.')
identifier('addslashes')
(('(')
variable('$this')
arrow('->')
identifier('href')
(('(')
single quoted string('''')
)(')')
)(')')
dot('.')
string('"';\" />\n"')
semicolon(';')
}('}')
php closing tag('?>\n')
html('</div>')